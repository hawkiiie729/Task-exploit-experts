const userModel = require("../Models/userModel");
const {sendMail}=require("../utility/nodemailer")


module.exports.signup = async function signup(req, res) {
  try {
    let dataObj = req.body;
    let user = await userModel.create(dataObj); //user created
    sendMail("signup", user);
    console.log(user);
    if (user) {
      res.json({
        message: "user signed up",
        data: user,
      });
    } else {
      res.json({
        message: "error",
      });
    }
  } catch (err) {
    res.json({
      message: err.message,
    });
  }
};


module.exports.forgetPassword = async function forgetPassword(req, res) {
    let { email } = req.body;
    try {
      const user = await userModel.findOne({ email: email });
      if (user) {
        //createResetToken is used to create a new token
        const resetToken = user.createResetToken();
        //resetpassword link
        let resetPasswordLink = `${req.protocol}://${req.get(
          "host"
        )}/resetpassword/${resetToken}`;
        //send email to user
        //nodemailer
        let obj = {
          resetPasswordLink: resetPasswordLink,
          email: email,
        };
        sendMail("resetpassword", obj);
        return res.json({
          message: "reset link has been sent to your email",
        });
      } else {
        return res.json({
          message: "please Sign up",
        });
      }
    } catch (err) {
      res.status(500).json({
        message: err.message,
      });
    }
  };

  module.exports.resetPassword = async function resetPassword(req, res) {
    try {
      const token = req.params.token;
      let { password } = req.body;
      const user = await userModel.findOne({ resetToken: token });
      if (user) {
        //resetPasswordHandler will update passeord in db
        user.resetPasswordHandler(password);
        await user.save();
        res.json({
          message: "Password Updated Successfully",
        });
      } else {
        res.json({
          message: "user not found",
        });
      }
    } catch (err) {
      message: err.message;
    }
  };

module.exports.getUser = async function getUser(req, res) {
    console.log("getuser fuinctiom");
  let {id} = req.params;
  //console.log(req.params);
  console.log(id);
  // console.log("user ki id",id);
  let user = await userModel.findById(id);
  if (user) {
    return res.json(user);
  } else {
    res.json({
      message: "user not found",
    });
  }
};
